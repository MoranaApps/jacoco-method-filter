name: ci

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - uses: coursier/cache-action@v6
      - name: Install sbt (sbt-extras)
        run: |
          curl -fsSL https://raw.githubusercontent.com/dwijnand/sbt-extras/master/sbt -o sbt
          chmod +x sbt
          sudo mv sbt /usr/local/bin/
      - run: sbt test

  jacoco-versions:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      versions: ${{ steps.versions.outputs.versions }}
    steps:
      - uses: actions/checkout@v4
      - id: versions
        name: Load JaCoCo versions
        run: |
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          from pathlib import Path

          p = Path('integration-tests/jacoco-versions.txt')
          versions = [
              line.strip()
              for line in p.read_text(encoding='utf-8').splitlines()
              if line.strip() and not line.strip().startswith('#')
          ]
          print('versions=' + json.dumps(versions))
          PY

  integration:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - uses: coursier/cache-action@v6
      - name: Install sbt (sbt-extras)
        run: |
          curl -fsSL https://raw.githubusercontent.com/dwijnand/sbt-extras/master/sbt -o sbt
          chmod +x sbt
          sudo mv sbt /usr/local/bin/
      - name: Install Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y maven
      - name: Integration tests
        # Publishes rewriter-core, sbt-plugin, and maven-plugin locally, then
        # runs all test-*.sh scripts end-to-end (no remote resolution).
        # sbt plugin path: publishLocal â†’ init-rules / verify / basic (compile+rewrite+test+report)
        run: ./integration-tests/run-all.sh

  jacoco-compat:
    needs: [build, jacoco-versions]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        jacoco-version: ${{ fromJson(needs.jacoco-versions.outputs.versions) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - uses: coursier/cache-action@v6
      - name: Cache JaCoCo JARs
        uses: actions/cache@v4
        with:
          path: target/jacoco-cache
          key: ${{ runner.os }}-jacoco-${{ hashFiles('integration-tests/jacoco-versions.txt') }}
          restore-keys: |
            ${{ runner.os }}-jacoco-
      - name: Install sbt (sbt-extras)
        run: |
          curl -fsSL https://raw.githubusercontent.com/dwijnand/sbt-extras/master/sbt -o sbt
          chmod +x sbt
          sudo mv sbt /usr/local/bin/
      - name: Build rewriter-core JAR
        run: sbt "project rewriterCore" +package
      - name: JaCoCo compatibility E2E test (v${{ matrix.jacoco-version }})
        env:
          JACOCO_CACHE_DIR: ${{ github.workspace }}/target/jacoco-cache
        run: bash integration-tests/test-jacoco-compat.sh ${{ matrix.jacoco-version }}
